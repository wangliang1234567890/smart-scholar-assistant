<!-- pages/camera/camera.wxml -->
<view class="page-container">
  <!-- 1. ç›¸æœºé¡µé¢ -->
  <view wx:if="{{!showCropping && !showAnalyzing}}" class="camera-container">
    <camera
      class="camera-view"
      device-position="{{devicePosition}}"
      flash="{{flashMode}}"
      bindinitdone="onCameraReady"
      binderror="onCameraError"
      bindstop="onCameraStop"
      wx:if="{{!showPreview && !showAnalyzing && !showCropper}}"
    >
      <!-- ç›¸æœºæ¡† -->
      <view class="camera-frame">
        <view class="frame-corner top-left"></view>
        <view class="frame-corner top-right"></view>
        <view class="frame-corner bottom-left"></view>
        <view class="frame-corner bottom-right"></view>
      </view>
      
      <!-- è¯†åˆ«æç¤º -->
      <view class="camera-tips">
        <view class="tip-text">è¯·å°†é¢˜ç›®ç½®äºæ¡†å†…</view>
        <view class="tip-desc">ç¡®ä¿å…‰çº¿å……è¶³ï¼Œæ–‡å­—æ¸…æ™°</view>
      </view>
    </camera>

    <!-- ç›¸æœºæ§åˆ¶æŒ‰é’® -->
    <view class="camera-controls">
      <view class="control-item" bind:tap="switchFlash">
        <text class="control-icon">ğŸ’¡</text>
        <text class="control-text">é—ªå…‰ç¯</text>
      </view>

      <view class="capture-button" bind:tap="takePhoto">
        <text class="capture-icon">ğŸ“·</text>
      </view>

      <view class="control-item" bind:tap="switchCamera">
        <text class="control-icon">ğŸ”„</text>
        <text class="control-text">ç¿»è½¬</text>
      </view>
    </view>
  </view>

  <!-- 2. è£å‰ªé¡µé¢ -->
  <view wx:if="{{showCropping}}" class="crop-container">
    <view class="crop-header">
      <text class="crop-title">è°ƒæ•´è¯†åˆ«åŒºåŸŸ</text>
      <text class="crop-desc">æ‹–æ‹½è°ƒæ•´æ¡†é€‰åŒºåŸŸï¼Œç¡®ä¿åŒ…å«å®Œæ•´é¢˜ç›®</text>
    </view>

    <view class="crop-image-container">
      <image 
        class="crop-image" 
        src="{{originalImagePath}}" 
        mode="aspectFit"
        style="width: {{imageDisplaySize.width}}px; height: {{imageDisplaySize.height}}px;"
        bindload="onCropImageLoad"
        binderror="onCropImageError"
      />
      
      <!-- è£å‰ªæ¡† -->
      <view 
        class="crop-box" 
        style="left: {{cropArea.x}}px; top: {{cropArea.y}}px; width: {{cropArea.width}}px; height: {{cropArea.height}}px;"
        catchtouchstart="onCropMove"
        catchtouchmove="onCropMove"
        catchtouchend="onCropMove"
        data-type="move"
      >
        <!-- å››ä¸ªè§’æŠŠæ‰‹ -->
        <view class="crop-handle crop-handle-tl" data-corner="top-left" catchtouchstart="onCropResize" catchtouchmove="onCropResize" catchtouchend="onCropResize"></view>
        <view class="crop-handle crop-handle-tr" data-corner="top-right" catchtouchstart="onCropResize" catchtouchmove="onCropResize" catchtouchend="onCropResize"></view>
        <view class="crop-handle crop-handle-bl" data-corner="bottom-left" catchtouchstart="onCropResize" catchtouchmove="onCropResize" catchtouchend="onCropResize"></view>
        <view class="crop-handle crop-handle-br" data-corner="bottom-right" catchtouchstart="onCropResize" catchtouchmove="onCropResize" catchtouchend="onCropResize"></view>
      </view>
    </view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="crop-actions">
      <button class="crop-btn crop-btn-reset" bind:tap="resetToCamera">
        é‡ç½®
      </button>
      <button class="crop-btn crop-btn-confirm" bind:tap="confirmCropAndAnalyze">
        ç¡®è®¤è£å‰ª
      </button>
    </view>
  </view>

  <!-- 3. AIåˆ†æé¡µé¢ -->
  <view wx:elif="{{showAnalyzing}}" class="analyzing-container">
    <view class="analyzing-content">
      <view class="analyzing-preview">
        <image 
          class="preview-image" 
          src="{{croppedImagePath || originalImagePath}}" 
          mode="aspectFit"
          binderror="onPreviewImageError"
        />
      </view>
      
      <view class="analyzing-progress">
        <view class="progress-title">ğŸ¤– AIæ­£åœ¨åˆ†æä¸­...</view>
        <view class="progress-desc">{{processingStatus}}</view>
        
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{progressStep * 25}}%"></view>
        </view>
        
        <view class="progress-percent">{{Math.round(progressStep * 25)}}%</view>
      </view>
      
      <view wx:if="{{hasError}}" class="error-container">
        <view class="error-icon">âŒ</view>
        <view class="error-message">{{errorMessage}}</view>
        <view class="error-actions">
          <button class="error-btn retry-btn" bind:tap="retryAnalysis">é‡è¯•</button>
          <button class="error-btn reset-btn" bind:tap="resetToCamera">é‡æ–°æ‹ç…§</button>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- éšè—çš„Canvasç”¨äºå›¾ç‰‡å¤„ç† -->
<canvas 
  id="compress-canvas" 
  canvas-id="compressCanvas"
  style="position: fixed; top: -1000px; left: -1000px; width: 100px; height: 100px;"
></canvas>

<!-- éšè—çš„Canvasç”¨äºå›¾ç‰‡è£å‰ª -->
<canvas 
  canvas-id="cropCanvas" 
  style="position: fixed; top: -9999px; left: -9999px; width: 800px; height: 800px;"
></canvas>

<!-- ç»“æœå¼¹çª— -->
<view class="result-modal" wx:if="{{showResultModal}}" catchtap="hideResultModal">
  <view class="result-content" catchtap="stopPropagation">
    <view class="result-header">
      <text class="result-title">è¯†åˆ«ç»“æœ</text>
      <view class="result-close" catchtap="hideResultModal">Ã—</view>
    </view>
    
    <view class="result-body">
      <view class="recognized-text">
        <text>{{ocrResult.text}}</text>
      </view>
      
      <view class="result-info">
        <text class="confidence">ç½®ä¿¡åº¦: {{ocrResult.confidence * 100}}%</text>
        <text class="question-type">ç±»å‹: {{ocrResult.questionType}}</text>
        <text class="subject">å­¦ç§‘: {{ocrResult.subject}}</text>
      </view>
    </view>
    
    <view class="result-actions">
      <button class="btn-secondary" catchtap="retakePhoto">é‡æ–°æ‹ç…§</button>
      <button class="btn-primary" catchtap="saveResult">ä¿å­˜ç»“æœ</button>
    </view>
  </view>
</view>

















