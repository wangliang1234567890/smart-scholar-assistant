<!--pages/report/report.wxml-->
<view class="report-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <van-loading type="spinner" size="32px">æŠ¥å‘Šç”Ÿæˆä¸­...</van-loading>
  </view>

  <!-- æŠ¥å‘Šå†…å®¹ -->
  <scroll-view wx:else class="report-content" scroll-y enable-back-to-top>
    
    <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
    <view class="time-range-section">
      <picker 
        range="{{timeRangeOptions}}" 
        range-key="label"
        bind:change="onTimeRangeChange"
      >
        <view class="time-range-picker">
          <text class="range-label">{{currentTimeRangeLabel}}æŠ¥å‘Š</text>
          <van-icon name="arrow-down" size="16" />
        </view>
      </picker>
    </view>

    <!-- å­¦ä¹ æ¦‚è§ˆ -->
    <view class="overview-section">
      <view class="section-title">
        <van-icon name="chart-trending-o" size="18" color="#4285F4" />
        <text>å­¦ä¹ æ¦‚è§ˆ</text>
      </view>
      
      <view class="overview-cards">
        <view class="overview-card primary">
          <view class="card-value">{{overview.totalMistakes}}</view>
          <view class="card-label">æ€»é”™é¢˜æ•°</view>
          <view class="card-trend">
            <van-icon name="arrow-up" size="12" color="#4CAF50" />
            <text class="trend-text">è¾ƒä¸Šå‘¨ +{{comparison.lastWeek || 5}}</text>
          </view>
        </view>
        
        <view class="overview-card success">
          <view class="card-value">{{overview.masteredCount}}</view>
          <view class="card-label">å·²æŒæ¡</view>
          <view class="card-progress">
            <text class="progress-text">æŒæ¡ç‡ {{overview.masteryRate}}%</text>
          </view>
        </view>
        
        <view class="overview-card warning">
          <view class="card-value">{{overview.practiceTime}}min</view>
          <view class="card-label">ç»ƒä¹ æ—¶é•¿</view>
          <view class="card-trend">
            <van-icon name="arrow-up" size="12" color="#4CAF50" />
            <text class="trend-text">è¾ƒä¸Šå‘¨ +15%</text>
          </view>
        </view>
        
        <view class="overview-card info">
          <view class="card-value">{{overview.improvementRate}}%</view>
          <view class="card-label">æ”¹è¿›ç‡</view>
          <view class="card-progress">
            <text class="progress-text">æœ¬å‘¨è¡¨ç°è‰¯å¥½</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ç§‘åˆ†æ -->
    <view class="subject-section">
      <view class="section-title">
        <van-icon name="bookmark" size="18" color="#4285F4" />
        <text>å­¦ç§‘åˆ†æ</text>
      </view>
      
      <view wx:if="{{subjectAnalysis.length > 0}}" class="subject-charts">
        <view wx:for="{{subjectAnalysis}}" wx:key="name" class="subject-item">
          <view class="subject-header">
            <view class="subject-info">
              <view class="subject-dot" style="background-color: {{item.color}};"></view>
              <text class="subject-name">{{item.name}}</text>
              <text class="subject-count">{{item.total}}é¢˜</text>
            </view>
            <view class="subject-accuracy">{{item.accuracy}}%</view>
          </view>
          
          <view class="subject-progress">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{item.accuracy}}%; background-color: {{item.color}};"></view>
            </view>
          </view>
          
          <view class="subject-stats">
            <view class="stat-item">
              <text class="stat-label">æŒæ¡ï¼š{{item.mastered}}é¢˜</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">ç”¨æ—¶ï¼š{{item.timeSpent}}min</text>
            </view>
            <view class="stat-item">
              <text class="stat-label success">æ”¹è¿›ï¼š+{{item.improvement}}%</text>
            </view>
          </view>
        </view>
      </view>
      
      <view wx:else class="empty-state">
        <van-empty description="æš‚æ— å­¦ç§‘æ•°æ®" />
      </view>
    </view>

    <!-- éš¾åº¦åˆ†æ -->
    <view class="difficulty-section">
      <view class="section-title">
        <van-icon name="medal" size="18" color="#4285F4" />
        <text>éš¾åº¦åˆ†æ</text>
      </view>
      
      <view wx:if="{{difficultyAnalysis.length > 0}}" class="difficulty-chart">
        <view wx:for="{{difficultyAnalysis}}" wx:key="level" class="difficulty-item">
          <view class="difficulty-info">
            <view class="difficulty-level" style="background-color: {{item.color}};">
              <text class="level-text">{{item.name}}</text>
            </view>
            <view class="difficulty-stats">
              <text class="stats-count">{{item.total}}é¢˜</text>
              <text class="stats-accuracy">å‡†ç¡®ç‡{{item.accuracy}}%</text>
            </view>
          </view>
          
          <view class="difficulty-progress">
            <view class="circle-progress" style="--progress: {{item.accuracy}}%; --color: {{item.color}};">
              <text class="progress-text">{{item.accuracy}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ è¶‹åŠ¿ -->
    <view class="trend-section">
      <view class="section-title">
        <van-icon name="chart-trending-o" size="18" color="#4285F4" />
        <text>å­¦ä¹ è¶‹åŠ¿</text>
      </view>
      
      <!-- æœ¬å‘¨è¶‹åŠ¿ -->
      <view class="trend-chart">
        <view class="chart-title">æœ¬å‘¨æ¯æ—¥å­¦ä¹ é‡</view>
        <view class="daily-chart">
          <view wx:for="{{timeTrend.daily}}" wx:key="day" class="day-bar">
            <view class="bar-value">{{item.count}}</view>
            <view class="bar-column" style="height: {{item.count > 0 ? (item.count / 10 * 80 + 20) : 20}}rpx;">
              <view class="bar-fill"></view>
            </view>
            <view class="bar-label">{{item.day}}</view>
          </view>
        </view>
      </view>
      
      <!-- æœˆåº¦å¯¹æ¯” -->
      <view class="monthly-comparison">
        <view class="comparison-title">æœˆåº¦å¯¹æ¯”</view>
        <view class="comparison-chart">
          <view wx:for="{{timeTrend.monthly}}" wx:key="month" class="month-item">
            <view class="month-bar">
              <view class="bar-bg">
                <view class="bar-progress" style="height: {{(item.count / 50) * 100}}%;"></view>
              </view>
              <text class="month-label">{{item.month}}</text>
              <text class="month-value">{{item.count}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ æ•ˆç‡ -->
    <view class="efficiency-section">
      <view class="section-title">
        <van-icon name="clock-o" size="18" color="#4285F4" />
        <text>å­¦ä¹ æ•ˆç‡</text>
      </view>
      
      <view class="efficiency-metrics">
        <view class="metric-item">
          <view class="metric-circle">
            <view class="circle-chart" style="--progress: {{efficiency.accuracyRate}}%;">
              <text class="circle-text">{{efficiency.accuracyRate}}%</text>
            </view>
          </view>
          <text class="metric-label">æ­£ç¡®ç‡</text>
        </view>
        
        <view class="metric-item">
          <view class="metric-circle">
            <view class="circle-chart" style="--progress: {{efficiency.completionRate}}%;">
              <text class="circle-text">{{efficiency.completionRate}}%</text>
            </view>
          </view>
          <text class="metric-label">å®Œæˆç‡</text>
        </view>
        
        <view class="metric-item">
          <view class="metric-circle">
            <view class="circle-chart" style="--progress: {{efficiency.focusLevel}}%;">
              <text class="circle-text">{{efficiency.focusLevel}}%</text>
            </view>
          </view>
          <text class="metric-label">ä¸“æ³¨åº¦</text>
        </view>
      </view>
      
      <view class="efficiency-details">
        <view class="detail-item">
          <van-icon name="clock-o" size="16" color="#666" />
          <text class="detail-text">å¹³å‡ç­”é¢˜æ—¶é—´ï¼š{{efficiency.averageTime}}ç§’</text>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ ä¹ æƒ¯ -->
    <view class="habits-section">
      <view class="section-title">
        <van-icon name="calendar" size="18" color="#4285F4" />
        <text>å­¦ä¹ ä¹ æƒ¯</text>
      </view>
      
      <view class="habits-grid">
        <view class="habit-card">
          <view class="habit-icon">ğŸ•</view>
          <view class="habit-info">
            <text class="habit-label">æœ€ä½³å­¦ä¹ æ—¶æ®µ</text>
            <text class="habit-value">{{habits.bestTimeSlot}}</text>
          </view>
        </view>
        
        <view class="habit-card">
          <view class="habit-icon">â±ï¸</view>
          <view class="habit-info">
            <text class="habit-label">å¹³å‡å•æ¬¡æ—¶é•¿</text>
            <text class="habit-value">{{habits.averageSessionTime}}åˆ†é’Ÿ</text>
          </view>
        </view>
        
        <view class="habit-card">
          <view class="habit-icon">ğŸ“…</view>
          <view class="habit-info">
            <text class="habit-label">æœ€æ´»è·ƒæ—¥æœŸ</text>
            <text class="habit-value">{{habits.mostActiveDay}}</text>
          </view>
        </view>
        
        <view class="habit-card">
          <view class="habit-icon">ğŸ¯</view>
          <view class="habit-info">
            <text class="habit-label">åå¥½éš¾åº¦</text>
            <text class="habit-value">{{habits.preferredDifficultyText}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆå°±å±•ç¤º -->
    <view class="achievements-section" wx:if="{{achievements.recent.length > 0 || achievements.progress.length > 0}}">
      <view class="section-title">
        <van-icon name="trophy" size="18" color="#4285F4" />
        <text>æˆå°±å±•ç¤º</text>
      </view>
      
      <!-- æœ€è¿‘è§£é” -->
      <view wx:if="{{achievements.recent.length > 0}}" class="recent-achievements">
        <view class="achievement-subtitle">æœ€è¿‘è§£é”</view>
        <view class="achievement-list">
          <view wx:for="{{achievements.recent}}" wx:key="id" class="achievement-item unlocked">
            <text class="achievement-icon">{{item.icon}}</text>
            <view class="achievement-info">
              <text class="achievement-name">{{item.name}}</text>
              <text class="achievement-desc">{{item.desc}}</text>
              <text class="achievement-date">{{item.unlockedAt}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è¿›åº¦æˆå°± -->
      <view wx:if="{{achievements.progress.length > 0}}" class="progress-achievements">
        <view class="achievement-subtitle">è¿›åº¦æˆå°±</view>
        <view class="progress-list">
          <view wx:for="{{achievements.progress}}" wx:key="id" class="progress-item">
            <text class="achievement-icon">{{item.icon}}</text>
            <view class="progress-info">
              <text class="achievement-name">{{item.name}}</text>
              <text class="achievement-desc">{{item.desc}}</text>
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.progress}}%;"></view>
              </view>
              <text class="progress-text">{{item.current}}/{{item.target}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ å»ºè®® -->
    <view class="suggestions-section">
      <view class="section-title">
        <van-icon name="bulb-o" size="18" color="#4285F4" />
        <text>å­¦ä¹ å»ºè®®</text>
      </view>
      
      <view wx:if="{{suggestions.length > 0}}" class="suggestions-list">
        <view wx:for="{{suggestions}}" wx:key="title" class="suggestion-item {{item.type}}">
          <view class="suggestion-icon">
            <van-icon 
              name="{{item.type === 'warning' ? 'warning-o' : item.type === 'success' ? 'success' : item.type === 'info' ? 'info-o' : 'bulb-o'}}" 
              size="20" 
            />
          </view>
          <view class="suggestion-content">
            <text class="suggestion-title">{{item.title}}</text>
            <text class="suggestion-desc">{{item.desc}}</text>
          </view>
          <view class="suggestion-action" bindtap="navigateToSuggestion" data-url="{{item.actionUrl}}">
            <text class="action-text">{{item.action}}</text>
            <van-icon name="arrow" size="14" />
          </view>
        </view>
      </view>
      
      <view wx:else class="empty-suggestions">
        <van-empty description="æš‚æ— å­¦ä¹ å»ºè®®" />
      </view>
    </view>

    <!-- æŠ¥å‘Šæ€»ç»“ -->
    <view class="summary-section">
      <view class="section-title">
        <van-icon name="completed" size="18" color="#4285F4" />
        <text>æŠ¥å‘Šæ€»ç»“</text>
      </view>
      
      <view class="summary-card">
        <view class="summary-content">
          <text class="summary-text">
            æœ¬{{currentTimeRangeLabel}}æ‚¨å…±å®Œæˆäº† <text class="highlight">{{overview.totalMistakes}}</text> é“é”™é¢˜ç»ƒä¹ ï¼Œ
            æŒæ¡äº†å…¶ä¸­ <text class="highlight">{{overview.masteredCount}}</text> é“ï¼ŒæŒæ¡ç‡ä¸º <text class="highlight">{{overview.masteryRate}}%</text>ã€‚
            å­¦ä¹ çŠ¶æ€è‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒï¼
          </text>
          
          <view class="summary-actions">
            <van-button type="primary" size="small" bind:click="refreshData">
              åˆ·æ–°æŠ¥å‘Š
            </van-button>
            <van-button type="default" size="small" open-type="share">
              åˆ†äº«æŠ¥å‘Š
            </van-button>
          </view>
        </view>
      </view>
    </view>

  </scroll-view>
</view> 