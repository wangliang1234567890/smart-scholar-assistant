<!--pages/mistakes/detail.wxml-->
<view class="detail-container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-header">
    <van-nav-bar 
      title="é¢˜ç›®è¯¦æƒ…" 
      left-arrow 
      bind:click-left="navigateBack"
      custom-class="nav-bar"
    />
  </view>

  <block wx:if="{{isLoading}}">
    <view class="loading-wrapper">
      <van-loading type="spinner" size="32px">åŠ è½½ä¸­...</van-loading>
    </view>
  </block>
  <block wx:elif="{{!mistake}}">
    <van-empty description="é”™é¢˜ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤" />
  </block>
  <block wx:else>
    <scroll-view class="detail-content" scroll-y enable-back-to-top>
      
      <!-- é¢˜ç›®ä¿¡æ¯å¡ç‰‡ -->
      <view class="subject-card">
        <view class="subject-header">
          <view class="subject-icon">
            <text class="subject-text">{{mistake.subject === 'æ•°å­¦' ? 'æ•°' : mistake.subject === 'è¯­æ–‡' ? 'è¯­' : mistake.subject === 'è‹±è¯­' ? 'è‹±' : 'ç†'}}</text>
          </view>
          <view class="subject-info">
            <view class="subject-title">é¢˜ç›®è¯¦æƒ…</view>
            <view class="subject-detail">{{mistake.subject}} Â· {{mistake.difficultyText}}</view>
          </view>
        </view>
      </view>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="stats-section">
        <view class="stats-item error">
          <van-icon name="warning-o" size="16" color="#ff4444" />
          <text class="stats-label">ç­”é¢˜é”™è¯¯</text>
        </view>
        
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-number">{{mistake.reviewCount || 2}}</text>
            <text class="stat-label">å¤ä¹ æ¬¡æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{formattedCreateDate}}</text>
            <text class="stat-label">å½•å…¥æ—¥æœŸ</text>
          </view>
          <view class="stat-item highlight">
            <text class="stat-number">{{formattedNextReviewDate}}</text>
            <text class="stat-label">ä¸‹æ¬¡å¤ä¹ </text>
          </view>
        </view>
      </view>

      <!-- é¢˜ç›®å†…å®¹ -->
      <view class="question-section">
        <view class="section-header">
          <van-icon name="bookmark-o" size="16" color="#4285F4" />
          <text class="section-title">é¢˜ç›®å†…å®¹</text>
        </view>
        
        <view class="question-content">
          <text class="question-text">{{mistake.question}}</text>
          
          <!-- é¢˜ç›®å›¾ç‰‡ -->
          <image 
            wx:if="{{mistake.imageUrl}}" 
            class="question-image" 
            src="{{mistake.imageUrl}}" 
            mode="widthFix"
            show-menu-by-longpress
          />
          
          <!-- é¢˜ç›®æ ‡ç­¾ -->
          <view class="question-tags">
            <view wx:for="{{mistake.tags || ['é™¤æ³•', 'å¹³å‡åˆ†é…', 'åº”ç”¨é¢˜']}}" wx:key="*this" class="tag-item">
              {{item}}
            </view>
          </view>
          
          <!-- éš¾åº¦ç­‰çº§ -->
          <view class="difficulty-section">
            <text class="difficulty-label">éš¾åº¦ç­‰çº§ï¼š</text>
            <view class="difficulty-tag {{mistake.difficulty}}">{{mistake.difficultyText}}</view>
          </view>
        </view>
      </view>

      <!-- ç­”æ¡ˆä¸è§£æ - ç›´æ¥æ˜¾ç¤º -->
      <view class="answer-section">
        <view class="section-header">
          <van-icon name="success" size="16" color="#4CAF50" />
          <text class="section-title">æ­£ç¡®ç­”æ¡ˆ</text>
          <view wx:if="{{isGeneratingAnswer}}" class="ai-generating">
            <van-loading type="spinner" size="14px" />
            <text class="generating-text">AIç”Ÿæˆä¸­...</text>
          </view>
        </view>
        
        <view class="answer-content">
          <view class="answer-display">
            <text class="answer-text">{{mistake.answer || aiAnswer || 'æ­£åœ¨ç”Ÿæˆç­”æ¡ˆ...'}}</text>
            <view wx:if="{{mistake.aiGenerated || aiAnswer}}" class="ai-badge">
              <van-icon name="star-o" size="12" color="#FF9800" />
              <text class="ai-text">AIç”Ÿæˆ</text>
            </view>
          </view>
        </view>
      </view>

      <!-- é¢˜ç›®è§£æ -->
      <view class="analysis-section" wx:if="{{mistake.analysis || aiAnalysis}}">
        <view class="section-header">
          <van-icon name="bulb-o" size="16" color="#FF9800" />
          <text class="section-title">é¢˜ç›®è§£æ</text>
        </view>
        
        <view class="analysis-content">
          <text class="analysis-text">{{mistake.analysis || aiAnalysis || 'æ­£åœ¨ç”Ÿæˆè§£æ...'}}</text>
        </view>
      </view>

      <!-- å­¦ä¹ å»ºè®® -->
      <view class="suggestion-section">
        <view class="section-header">
          <van-icon name="star-o" size="16" color="#9C27B0" />
          <text class="section-title">å­¦ä¹ å»ºè®®</text>
        </view>
        
        <view class="suggestion-content">
          <view class="suggestion-item">
            <van-icon name="bulb-o" size="14" color="#FF9800" />
            <text class="suggestion-text">å¤šç»ƒä¹ å¹³å‡åˆ†é…ç±»å‹çš„é¢˜ç›®ï¼ŒæŒæ¡é™¤æ³•è¿ç®—è§„å¾‹</text>
          </view>
          <view class="suggestion-item">
            <van-icon name="edit" size="14" color="#2196F3" />
            <text class="suggestion-text">å¯ä»¥é€šè¿‡ç”»å›¾çš„æ–¹å¼ç†è§£å¹³å‡åˆ†é…çš„æ¦‚å¿µ</text>
          </view>
        </view>
      </view>

      <!-- ç›¸å…³é¢˜ç›® -->
      <view class="related-section" wx:if="{{relatedMistakes.length > 0}}">
        <view class="section-header">
          <view class="section-icon">ğŸ”—</view>
          <text class="section-title">ç›¸å…³é¢˜ç›®</text>
        </view>
        <view class="related-item" 
              wx:for="{{relatedMistakes}}" 
              wx:key="_id"
              bind:tap="navigateToRelated" 
              data-url="/pages/mistakes/detail?id={{item._id}}">
          <text class="related-text">{{item.question}}</text>
          <view class="related-arrow">â†’</view>
        </view>
      </view>

    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="bottom-actions">
      <van-button 
        icon="clock-o" 
        type="primary" 
        size="large"
        block
        bind:click="handleAddToReview"
        custom-class="review-plan-btn"
      >
        åŠ å…¥å¤ä¹ è®¡åˆ’
      </van-button>
    </view>

  </block>
</view>