<!--pages/practice/session.wxml-->
<view class="session-container">
  <!-- AIé¢˜ç›®ç”Ÿæˆä¸­é¡µé¢ -->
  <view wx:if="{{generatingQuestions}}" class="generating-container">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <view class="generating-header">
      <view class="generating-title">AIæ™ºèƒ½å‡ºé¢˜ä¸­</view>
      <view class="generating-subtitle">æ­£åœ¨æ ¹æ®æ‚¨çš„éœ€æ±‚ç”Ÿæˆä¸“å±ç»ƒä¹ é¢˜ç›®</view>
    </view>

    <!-- AIç”ŸæˆåŠ¨ç”» -->
    <view class="ai-animation-container">
      <view class="ai-brain-icon">
        <view class="brain-wave wave-1"></view>
        <view class="brain-wave wave-2"></view>
        <view class="brain-wave wave-3"></view>
        <view class="brain-core">
          <van-icon name="star" size="48rpx" color="white" />
        </view>
      </view>
    </view>

    <!-- ç”Ÿæˆè¿›åº¦ -->
    <view class="generation-progress">
      <view class="progress-circle-container">
        <view class="progress-circle">
          <view class="progress-ring">
            <view class="progress-fill" style="transform: rotate({{progressRotation}}deg);"></view>
          </view>
          <view class="progress-center">
            <view class="progress-percentage">{{generationProgress}}%</view>
          </view>
        </view>
      </view>
      
      <view class="generation-status">
        <view class="status-text">{{generationStatus}}</view>
        <view class="status-details">
          <text class="detail-item">å­¦ç§‘ï¼š{{practiceOptions.subject || 'æ•°å­¦'}}</text>
          <text class="detail-item">é¢˜ç›®æ•°é‡ï¼š{{practiceOptions.count || 5}}é“</text>
          <text class="detail-item">éš¾åº¦ï¼š{{practiceOptions.difficulty || 'ä¸­ç­‰'}}</text>
        </view>
      </view>
    </view>

    <!-- å–æ¶ˆæŒ‰é’® -->
    <view class="generating-actions">
      <van-button round type="default" size="large" bind:click="cancelGeneration">
        å–æ¶ˆç”Ÿæˆ
      </van-button>
    </view>
  </view>

  <!-- æ­£åœ¨æ‰¹æ”¹é¡µé¢ -->
  <view wx:elif="{{isGrading}}" class="grading-container">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <view class="grading-header">
      <view class="grading-title">AIæ™ºèƒ½æ‰¹æ”¹ä¸­</view>
      <view class="grading-subtitle">æ­£åœ¨åˆ†ææ‚¨çš„ç­”æ¡ˆå¹¶ç»™å‡ºè¯¦ç»†åé¦ˆ</view>
    </view>

    <!-- æ‰¹æ”¹åŠ¨ç”» -->
    <view class="grading-animation">
      <view class="grading-icon">
        <van-icon name="edit" size="80rpx" color="#4F46E5" />
        <view class="grading-sparkles">
          <view class="sparkle sparkle-1"></view>
          <view class="sparkle sparkle-2"></view>
          <view class="sparkle sparkle-3"></view>
          <view class="sparkle sparkle-4"></view>
        </view>
      </view>
    </view>

    <!-- æ‰¹æ”¹è¿›åº¦ -->
    <view class="grading-progress">
      <view class="grading-steps">
        <view class="step-item {{gradingStep >= 1 ? 'active' : ''}} {{gradingStep > 1 ? 'completed' : ''}}">
          <view class="step-icon">
            <van-icon wx:if="{{gradingStep > 1}}" name="success" size="16px" color="#10B981" />
            <van-icon wx:elif="{{gradingStep === 1}}" name="loading" size="16px" color="#4F46E5" />
            <text wx:else class="step-number">1</text>
          </view>
          <view class="step-content">
            <view class="step-title">åˆ†æç­”æ¡ˆ</view>
          </view>
        </view>

        <view class="step-item {{gradingStep >= 2 ? 'active' : ''}} {{gradingStep > 2 ? 'completed' : ''}}">
          <view class="step-icon">
            <van-icon wx:if="{{gradingStep > 2}}" name="success" size="16px" color="#10B981" />
            <van-icon wx:elif="{{gradingStep === 2}}" name="loading" size="16px" color="#4F46E5" />
            <text wx:else class="step-number">2</text>
          </view>
          <view class="step-content">
            <view class="step-title">æ™ºèƒ½è¯„åˆ†</view>
          </view>
        </view>

        <view class="step-item {{gradingStep >= 3 ? 'active' : ''}} {{gradingStep > 3 ? 'completed' : ''}}">
          <view class="step-icon">
            <van-icon wx:if="{{gradingStep > 3}}" name="success" size="16px" color="#10B981" />
            <van-icon wx:elif="{{gradingStep === 3}}" name="loading" size="16px" color="#4F46E5" />
            <text wx:else class="step-number">3</text>
          </view>
          <view class="step-content">
            <view class="step-title">ç”ŸæˆæŠ¥å‘Š</view>
          </view>
        </view>
      </view>

      <view class="grading-status">
        <view class="status-text">{{gradingStatus || 'æ­£åœ¨æ‰¹æ”¹ç­”æ¡ˆ...'}}</view>
        <view class="grading-details">
          <text class="detail-item">å·²å®Œæˆï¼š{{gradedCount || 0}}/{{questions.length}}é¢˜</text>
          <text class="detail-item">é¢„è®¡å‰©ä½™ï¼š{{remainingQuestions}}é¢˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ­£å¸¸ç­”é¢˜é¡µé¢ -->
  <view wx:elif="{{!isLoading}}" class="practice-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <van-loading type="spinner" size="32px" color="#4F46E5">åŠ è½½ä¸­...</van-loading>
    </view>

    <!-- ç»ƒä¹ å†…å®¹ -->
    <view wx:else class="practice-content">
      <!-- é¡¶éƒ¨è¿›åº¦åŒºåŸŸ -->
      <view class="progress-section">
        <view class="progress-header">
        <view class="progress-info">
            <view class="question-number">
              <text class="current-number">{{currentIndex + 1}}</text>
              <text class="total-number">/{{totalQuestions}}</text>
        </view>
            <view class="subject-badge">{{currentQuestion.subject}}</view>
          </view>
          <view class="header-actions">
            <view class="exit-button" bindtap="showExitDialog">
              <van-icon name="cross" size="16px" color="#6B7280" />
            </view>
          </view>
      </view>

      <!-- è¿›åº¦æ¡ -->
        <view class="progress-bar-container">
      <van-progress 
        percentage="{{(currentIndex + 1) / totalQuestions * 100}}" 
            stroke-width="6" 
            color="#4F46E5"
            track-color="#F3F4F6"
          />
          <view class="progress-label">å·²å®Œæˆ {{currentIndex + 1}}/{{totalQuestions}} é¢˜</view>
        </view>
      </view>

      <!-- é¢˜ç›®å¡ç‰‡ -->
      <view class="question-section">
        <!-- é¢˜ç›®å¤´éƒ¨ä¿¡æ¯ -->
        <view class="question-header">
          <view class="question-type-badge {{currentQuestion.type || 'single_choice'}}">
            <block wx:if="{{currentQuestion.type === 'choice' || currentQuestion.type === 'single_choice'}}">å•é€‰é¢˜</block>
            <block wx:elif="{{currentQuestion.type === 'multiple_choice'}}">å¤šé€‰é¢˜</block>
            <block wx:elif="{{currentQuestion.type === 'input' || currentQuestion.type === 'fill_blank'}}">å¡«ç©ºé¢˜</block>
            <block wx:elif="{{currentQuestion.type === 'short_answer' || currentQuestion.type === 'solve'}}">è§£ç­”é¢˜</block>
            <block wx:else>é€‰æ‹©é¢˜</block>
          </view>
        </view>

      <!-- é¢˜ç›®å†…å®¹ -->
      <view class="question-content">
          <view class="question-title">{{currentQuestion.question}}</view>
          <view wx:if="{{currentQuestion.stem}}" class="question-stem">{{currentQuestion.stem}}</view>
        </view>

        <!-- é¢˜ç›®æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰ -->
        <view wx:if="{{currentQuestion.tip}}" class="question-tip">
          <van-icon name="info" size="16px" color="#F59E0B" />
          <text class="tip-text">{{currentQuestion.tip}}</text>
        </view>
      </view>
        
        <!-- é€‰æ‹©é¢˜é€‰é¡¹ -->
      <view wx:if="{{(currentQuestion.type === 'choice' || currentQuestion.type === 'single_choice' || currentQuestion.type === 'multiple_choice') && currentQuestion.options && currentQuestion.options.length > 0}}" class="options-section">
          <view 
            wx:for="{{currentQuestion.options}}" 
            wx:key="index"
          class="option-wrapper {{userAnswer === index ? 'active' : ''}}"
          data-index="{{index}}"
            data-answer="{{item}}"
            bindtap="onSelectAnswer"
          >
          <view class="option-indicator">
            <view class="radio-circle {{userAnswer === index ? 'checked' : ''}}">
              <view wx:if="{{userAnswer === index}}" class="radio-dot"></view>
            </view>
          </view>
          <view class="option-content">
            <text class="option-label">{{String.fromCharCode(65 + index)}}</text>
            <text class="option-text">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- å¡«ç©ºé¢˜è¾“å…¥ -->
      <view wx:elif="{{currentQuestion.type === 'input' || currentQuestion.type === 'fill_blank'}}" class="fill-blank-container">
        <van-field
          value="{{userAnswerText}}"
          placeholder="ğŸ’¡ è¯·åœ¨æ­¤è¾“å…¥ç­”æ¡ˆ"
          type="textarea"
          autosize="{{true}}"
          border="{{false}}"
          class="fill-blank-input"
          bind:change="onAnswerInput"
        />
        <view class="input-footer">
          <text class="char-count">{{userAnswerText ? userAnswerText.length : 0}}/200å­—</text>
          </view>
        </view>

      <!-- è§£ç­”é¢˜è¾“å…¥ -->
      <view wx:elif="{{currentQuestion.type === 'solve' || currentQuestion.type === 'short_answer' || (currentQuestion.type === 'input' && currentQuestion.question.length > 100)}}" class="solve-container">
          <van-field
          value="{{userAnswerText}}"
          placeholder="ğŸ“ è¯·åœ¨æ­¤è¯¦ç»†å†™å‡ºè§£ç­”è¿‡ç¨‹..."
          type="textarea"
          autosize="{{true}}"
          border="{{false}}"
          class="solve-input"
            bind:change="onAnswerInput"
          />
        <view class="input-footer">
          <text class="char-count">{{userAnswerText ? userAnswerText.length : 0}}/500å­—</text>
        </view>
      </view>

      <!-- çŸ¥è¯†ç‚¹æç¤º -->
      <view wx:if="{{currentQuestion.knowledgePoints && currentQuestion.knowledgePoints.length > 0}}" class="knowledge-points">
        <view class="knowledge-header">
          <van-icon name="star" size="16px" color="#F59E0B" />
          <text class="knowledge-title">ç›¸å…³çŸ¥è¯†ç‚¹</text>
        </view>
        <view class="knowledge-tags">
          <text wx:for="{{currentQuestion.knowledgePoints}}" wx:key="*this" class="knowledge-tag">{{item}}</text>
        </view>
      </view>

      <!-- åº•éƒ¨å¯¼èˆªæŒ‰é’® -->
      <view class="navigation-section">
        <view 
          wx:if="{{currentIndex > 0}}"
          class="nav-btn prev-btn"
          bindtap="prevQuestion"
        >
          ä¸Šä¸€é¢˜
        </view>
        
        <view 
          class="nav-btn next-btn"
          bindtap="nextQuestion"
        >
          {{currentIndex < totalQuestions - 1 ? 'ä¸‹ä¸€é¢˜' : 'å®Œæˆç­”é¢˜'}}
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:else class="loading-container">
    <van-loading type="spinner" size="32px" color="#4F46E5">
      æ­£åœ¨åŠ è½½é¢˜ç›®...
    </van-loading>
  </view>

  <!-- é€€å‡ºç¡®è®¤å¼¹çª— -->
  <van-dialog
    show="{{showExitDialog}}"
    title="ç¡®è®¤é€€å‡º"
    message="é€€å‡ºåå°†ä¸ä¼šä¿å­˜æœ¬æ¬¡ç»ƒä¹ è®°å½•ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ"
    show-cancel-button
    confirm-button-text="ç¡®è®¤é€€å‡º"
    cancel-button-text="ç»§ç»­ç»ƒä¹ "
    bind:confirm="confirmExit"
    bind:cancel="cancelExit"
  />

  <!-- æäº¤ç¡®è®¤å¼¹çª— -->
  <van-dialog
    show="{{showSubmitDialog}}"
    title="æäº¤ç­”æ¡ˆ"
    message="{{submitMessage ? submitMessage : 'ç¡®å®šè¦æäº¤ç­”æ¡ˆå—ï¼Ÿ'}}"
    show-cancel-button
    confirm-button-text="ç¡®è®¤æäº¤"
    cancel-button-text="ç»§ç»­ç­”é¢˜"
    bind:confirm="confirmSubmit"
    bind:cancel="cancelSubmit"
  />
</view> 
